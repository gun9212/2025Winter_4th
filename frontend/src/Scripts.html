<script>
  /**
   * Council-AI Frontend Scripts
   */

  // Global state
  let currentSearchResult = null;

  // DOM Ready
  document.addEventListener('DOMContentLoaded', function() {
    initTabs();
    initMinutesTab();
    initSearchTab();
    initCalendarTab();
  });

  /**
   * íƒ­ ì´ˆê¸°í™”
   */
  function initTabs() {
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabBtns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        const tabId = this.dataset.tab;

        // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
        tabBtns.forEach(function(b) { b.classList.remove('active'); });
        this.classList.add('active');

        // íƒ­ ì½˜í…ì¸  í‘œì‹œ
        tabContents.forEach(function(content) {
          content.classList.remove('active');
        });
        document.getElementById(tabId + '-tab').classList.add('active');
      });
    });
  }

  /**
   * íšŒì˜ë¡ íƒ­ ì´ˆê¸°í™”
   */
  function initMinutesTab() {
    const processBtn = document.getElementById('process-minutes-btn');
    const transcriptInput = document.getElementById('transcript');

    processBtn.addEventListener('click', function() {
      const transcript = transcriptInput.value.trim();

      if (!transcript) {
        showToast('ì†ê¸°ë¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      processMinutes(transcript);
    });
  }

  /**
   * íšŒì˜ë¡ ì²˜ë¦¬
   */
  function processMinutes(transcript) {
    showLoading(true);

    google.script.run
      .withSuccessHandler(function(result) {
        showLoading(false);

        const resultBox = document.getElementById('minutes-result');
        const statusEl = document.getElementById('minutes-status');
        const detailsEl = document.getElementById('minutes-details');
        const statusIcon = resultBox.querySelector('.status-icon');

        resultBox.classList.remove('hidden');

        if (result.success) {
          statusIcon.textContent = 'â³';
          statusEl.textContent = 'ì²˜ë¦¬ ì‹œì‘ë¨';
          detailsEl.textContent = 'ì‘ì—… ID: ' + result.data.task_id;

          // ìƒíƒœ í´ë§ ì‹œì‘
          pollMinutesStatus(result.data.task_id);
        } else {
          statusIcon.textContent = 'âŒ';
          statusEl.textContent = 'ì˜¤ë¥˜ ë°œìƒ';
          detailsEl.textContent = result.error;
        }
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showToast('ì˜¤ë¥˜: ' + error.message, 'error');
      })
      .processMinutes(transcript);
  }

  /**
   * íšŒì˜ë¡ ìƒíƒœ í´ë§
   */
  function pollMinutesStatus(taskId) {
    const statusEl = document.getElementById('minutes-status');
    const detailsEl = document.getElementById('minutes-details');
    const statusIcon = document.querySelector('#minutes-result .status-icon');

    const poll = function() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            const data = result.data;

            if (data.status === 'completed') {
              statusIcon.textContent = 'âœ…';
              statusEl.textContent = 'ì™„ë£Œ!';
              detailsEl.innerHTML =
                '<p>ê²°ê³¼ ë¬¸ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>' +
                '<a href="' + data.result_doc_url + '" target="_blank">ë¬¸ì„œ ì—´ê¸°</a>';
              showToast('íšŒì˜ë¡ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } else if (data.status === 'failed') {
              statusIcon.textContent = 'âŒ';
              statusEl.textContent = 'ì‹¤íŒ¨';
              detailsEl.textContent = data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
            } else {
              statusEl.textContent = 'ì²˜ë¦¬ ì¤‘... ' + data.progress + '%';
              setTimeout(poll, 2000);
            }
          }
        })
        .withFailureHandler(function() {
          setTimeout(poll, 5000);
        })
        .getMinutesStatus(taskId);
    };

    setTimeout(poll, 2000);
  }

  /**
   * ê²€ìƒ‰ íƒ­ ì´ˆê¸°í™”
   */
  function initSearchTab() {
    const searchBtn = document.getElementById('search-btn');
    const insertBtn = document.getElementById('insert-answer-btn');
    const queryInput = document.getElementById('search-query');

    searchBtn.addEventListener('click', function() {
      const query = queryInput.value.trim();
      const topK = parseInt(document.getElementById('top-k').value);

      if (!query) {
        showToast('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      performSearch(query, topK);
    });

    // ì—”í„° í‚¤ë¡œ ê²€ìƒ‰
    queryInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchBtn.click();
      }
    });

    insertBtn.addEventListener('click', function() {
      if (currentSearchResult) {
        insertSearchResult();
      }
    });
  }

  /**
   * ê²€ìƒ‰ ìˆ˜í–‰
   */
  function performSearch(query, topK) {
    showLoading(true);

    google.script.run
      .withSuccessHandler(function(result) {
        showLoading(false);

        const resultBox = document.getElementById('search-result');
        const answerEl = document.getElementById('search-answer');
        const sourcesEl = document.getElementById('search-sources');

        if (result.success) {
          const data = result.data;
          currentSearchResult = data;

          resultBox.classList.remove('hidden');

          // ë‹µë³€ í‘œì‹œ
          answerEl.textContent = data.answer || 'ê´€ë ¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';

          // ì†ŒìŠ¤ í‘œì‹œ
          sourcesEl.innerHTML = '';
          if (data.sources && data.sources.length > 0) {
            data.sources.forEach(function(source) {
              const li = document.createElement('li');
              const a = document.createElement('a');
              a.href = source.url || '#';
              a.target = '_blank';
              a.textContent = source.document_name;
              li.appendChild(a);
              sourcesEl.appendChild(li);
            });
          } else {
            sourcesEl.innerHTML = '<li>ì°¸ê³  ë¬¸ì„œ ì—†ìŒ</li>';
          }

          // ì œíœ´ ì •ë³´ í‘œì‹œ
          if (data.partner_info) {
            showPartnerInfo(data.partner_info);
          }
        } else {
          showToast('ê²€ìƒ‰ ì‹¤íŒ¨: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showToast('ì˜¤ë¥˜: ' + error.message, 'error');
      })
      .searchKnowledge(query, topK);
  }

  /**
   * ì œíœ´ ì •ë³´ í‘œì‹œ
   */
  function showPartnerInfo(info) {
    const resultBox = document.getElementById('search-result');

    // ê¸°ì¡´ ì œíœ´ ì •ë³´ ì œê±°
    const existingInfo = resultBox.querySelector('.partner-info');
    if (existingInfo) {
      existingInfo.remove();
    }

    const div = document.createElement('div');
    div.className = 'partner-info';
    div.innerHTML =
      '<h5>ğŸ ì œíœ´ ì—…ì²´ ì •ë³´</h5>' +
      '<p><strong>' + info.name + '</strong></p>' +
      '<p>í• ì¸: ' + info.discount + '</p>' +
      '<p>ë¬¸ì˜: ' + info.contact + '</p>';

    resultBox.appendChild(div);
  }

  /**
   * ê²€ìƒ‰ ê²°ê³¼ ë¬¸ì„œì— ì‚½ì…
   */
  function insertSearchResult() {
    if (!currentSearchResult) return;

    showLoading(true);

    google.script.run
      .withSuccessHandler(function() {
        showLoading(false);
        showToast('ë¬¸ì„œì— ì‚½ì…ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showToast('ì‚½ì… ì‹¤íŒ¨: ' + error.message, 'error');
      })
      .insertSearchResult(
        currentSearchResult.answer,
        currentSearchResult.sources
      );
  }

  /**
   * ìº˜ë¦°ë” íƒ­ ì´ˆê¸°í™”
   */
  function initCalendarTab() {
    const extractBtn = document.getElementById('extract-events-btn');
    const registerAllBtn = document.getElementById('register-all-btn');

    extractBtn.addEventListener('click', function() {
      extractEvents();
    });

    registerAllBtn.addEventListener('click', function() {
      registerAllEvents();
    });
  }

  /**
   * ì¼ì • ì¶”ì¶œ
   */
  function extractEvents() {
    showLoading(true);

    google.script.run
      .withSuccessHandler(function(result) {
        showLoading(false);

        const resultBox = document.getElementById('calendar-result');
        const eventsListEl = document.getElementById('events-list');
        const registerBtn = document.getElementById('register-all-btn');

        if (result.success) {
          const events = result.data.events || [];

          resultBox.classList.remove('hidden');
          eventsListEl.innerHTML = '';

          if (events.length > 0) {
            registerBtn.classList.remove('hidden');

            events.forEach(function(event, index) {
              const div = document.createElement('div');
              div.className = 'event-item';
              div.dataset.index = index;
              div.innerHTML =
                '<div class="event-title">' + event.title + '</div>' +
                '<div class="event-date">' + event.date + (event.time ? ' ' + event.time : '') + '</div>' +
                '<div class="event-actions">' +
                  '<button class="btn btn-secondary register-single-btn">ë“±ë¡</button>' +
                '</div>';
              eventsListEl.appendChild(div);
            });

            // ê°œë³„ ë“±ë¡ ë²„íŠ¼ ì´ë²¤íŠ¸
            eventsListEl.querySelectorAll('.register-single-btn').forEach(function(btn) {
              btn.addEventListener('click', function() {
                const index = parseInt(this.closest('.event-item').dataset.index);
                registerEvent(events[index], this);
              });
            });
          } else {
            eventsListEl.innerHTML = '<p>ì¶”ì¶œëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            registerBtn.classList.add('hidden');
          }
        } else {
          showToast('ì¼ì • ì¶”ì¶œ ì‹¤íŒ¨: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showToast('ì˜¤ë¥˜: ' + error.message, 'error');
      })
      .extractCalendarEvents();
  }

  /**
   * ë‹¨ì¼ ì´ë²¤íŠ¸ ë“±ë¡
   */
  function registerEvent(event, btn) {
    btn.disabled = true;
    btn.textContent = 'ë“±ë¡ ì¤‘...';

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          btn.textContent = 'ë“±ë¡ë¨ âœ“';
          btn.classList.add('success');
          showToast('ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } else {
          btn.disabled = false;
          btn.textContent = 'ë“±ë¡';
          showToast('ë“±ë¡ ì‹¤íŒ¨: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        btn.disabled = false;
        btn.textContent = 'ë“±ë¡';
        showToast('ì˜¤ë¥˜: ' + error.message, 'error');
      })
      .createCalendarEvent(event);
  }

  /**
   * ëª¨ë“  ì´ë²¤íŠ¸ ë“±ë¡
   */
  function registerAllEvents() {
    const btns = document.querySelectorAll('.register-single-btn:not(:disabled)');
    btns.forEach(function(btn) {
      btn.click();
    });
  }

  /**
   * ë¡œë”© í‘œì‹œ
   */
  function showLoading(show) {
    const overlay = document.getElementById('loading-overlay');
    if (show) {
      overlay.classList.remove('hidden');
    } else {
      overlay.classList.add('hidden');
    }
  }

  /**
   * í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
   */
  function showToast(message, type) {
    // ê¸°ì¡´ í† ìŠ¤íŠ¸ ì œê±°
    const existing = document.querySelector('.toast');
    if (existing) {
      existing.remove();
    }

    const toast = document.createElement('div');
    toast.className = 'toast ' + (type || '');
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(function() {
      toast.remove();
    }, 3000);
  }
</script>
