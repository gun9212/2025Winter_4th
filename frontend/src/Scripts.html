<script>
  /**
   * ========================================
   * Council-AI Frontend Scripts
   * Version: 2.0.0
   * ========================================
   */

  // ============================================
  // ì „ì—­ ìƒíƒœ
  // ============================================
  const State = {
    chatSessionId: null,
    chatHistory: [],
    currentTab: 'chat',
    pollingIntervals: {},
    pickerLoaded: false,
    oauthToken: null,
    developerKey: null
  };

  // ============================================
  // ì´ˆê¸°í™”
  // ============================================
  document.addEventListener('DOMContentLoaded', function () {
    initApp();
  });

  async function initApp() {
    console.log('[Council-AI] Initializing...');

    // ì‚¬ìš©ì ì´ë©”ì¼ í‘œì‹œ
    loadUserEmail();

    // íƒ­ ì´ˆê¸°í™”
    initTabs();

    // ì €ì¥ëœ ìƒíƒœ ë³µì›
    restoreState();

    // ê° íƒ­ ì´ˆê¸°í™”
    initChatTab();
    initDocsTab();
    initCalendarTab();
    initAdminTab();

    // Picker API ë¡œë“œ
    loadPickerApi();

    // ì„¤ì • ë¡œë“œ
    loadSettings();

    // ê¸°ë³¸ íƒ­ í™œì„±í™”
    activateTab('chat');

    console.log('[Council-AI] Initialized');
  }

  // ============================================
  // ì‚¬ìš©ì ì •ë³´
  // ============================================
  function loadUserEmail() {
    google.script.run
      .withSuccessHandler(function (email) {
        document.getElementById('user-email').textContent = email || '';
      })
      .getCurrentUserEmail();
  }

  // ============================================
  // íƒ­ ê´€ë¦¬
  // ============================================
  function initTabs() {
    const tabBtns = document.querySelectorAll('.tab-btn');
    console.log('[Council-AI] initTabs - found', tabBtns.length, 'tab buttons');

    tabBtns.forEach(function (btn) {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        const tabId = this.dataset.tab;
        console.log('[Council-AI] Tab clicked:', tabId);
        activateTab(tabId);
      });
    });
  }

  function activateTab(tabId) {
    console.log('[Council-AI] activateTab called with:', tabId);

    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.tab-btn').forEach(function (btn) {
      btn.classList.remove('border-google-blue', 'text-google-blue', 'bg-blue-50');
      btn.classList.add('border-transparent');
    });

    const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
    console.log('[Council-AI] Found active button:', !!activeBtn);
    if (activeBtn) {
      activeBtn.classList.add('border-google-blue', 'text-google-blue', 'bg-blue-50');
      activeBtn.classList.remove('border-transparent');
    }

    // ì½˜í…ì¸  í‘œì‹œ
    const allTabs = document.querySelectorAll('.tab-content');
    console.log('[Council-AI] Found', allTabs.length, 'tab contents');
    allTabs.forEach(function (content) {
      content.classList.remove('active');
    });

    const activeContent = document.getElementById(tabId + '-tab');
    console.log('[Council-AI] Found active content:', tabId + '-tab', !!activeContent);
    if (activeContent) {
      activeContent.classList.add('active');
      console.log('[Council-AI] Tab activated successfully:', tabId);
    } else {
      console.error('[Council-AI] Tab content not found:', tabId + '-tab');
    }

    State.currentTab = tabId;
    saveUserProperty('lastTab', tabId);
  }

  // ============================================
  // ìƒíƒœ ì €ì¥/ë³µì›
  // ============================================
  function restoreState() {
    // ë§ˆì§€ë§‰ íƒ­ ë³µì›
    google.script.run
      .withSuccessHandler(function (lastTab) {
        if (lastTab) {
          activateTab(lastTab);
        }
      })
      .getUserProperty('lastTab');

    // ì±„íŒ… ì„¸ì…˜ ID ë³µì› ë° íˆìŠ¤í† ë¦¬ ë¡œë“œ
    google.script.run
      .withSuccessHandler(function (sessionId) {
        if (sessionId) {
          State.chatSessionId = sessionId;
          // ì„¸ì…˜ì´ ìˆìœ¼ë©´ íˆìŠ¤í† ë¦¬ ë¡œë“œ
          loadChatHistory(sessionId);
        }
      })
      .getChatSessionId();
  }

  // ì±„íŒ… íˆìŠ¤í† ë¦¬ ë¡œë“œ (ë°±ì—”ë“œì—ì„œ)
  function loadChatHistory(sessionId) {
    console.log('[Council-AI] Loading chat history for session:', sessionId);

    google.script.run
      .withSuccessHandler(function (result) {
        if (result.success && result.data && result.data.messages) {
          const messages = result.data.messages;

          if (messages.length > 0) {
            // ì›°ì»´ ë©”ì‹œì§€ ì œê±°
            const container = document.getElementById('chat-history');
            const welcome = container.querySelector('.text-center');
            if (welcome) {
              welcome.remove();
            }

            // íˆìŠ¤í† ë¦¬ ë Œë”ë§
            messages.forEach(function (msg) {
              if (msg.role === 'user' || msg.role === 'assistant') {
                addChatMessage(msg.role, msg.content, false, msg.sources);
              }
            });

            // ìƒíƒœì—ë„ ì €ì¥
            State.chatHistory = messages;

            console.log('[Council-AI] Restored', messages.length, 'messages');
          }
        }
      })
      .withFailureHandler(function (error) {
        console.warn('[Council-AI] Failed to load chat history:', error);
      })
      .apiGetChatHistory(sessionId);
  }

  function saveUserProperty(key, value) {
    google.script.run.saveUserProperty(key, value);
  }

  // ============================================
  // Chat Tab
  // ============================================
  function initChatTab() {
    const input = document.getElementById('chat-input');
    const sendBtn = document.getElementById('chat-send-btn');
    const clearBtn = document.getElementById('chat-clear-btn');

    // Enter í‚¤ë¡œ ì „ì†¡
    input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
      }
    });

    // ì „ì†¡ ë²„íŠ¼
    sendBtn.addEventListener('click', sendChatMessage);

    // ëŒ€í™” ì´ˆê¸°í™”
    clearBtn.addEventListener('click', clearChat);
  }

  function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const query = input.value.trim();

    if (!query) {
      showToast('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
      return;
    }

    // ì…ë ¥ì°½ ë¹„ìš°ê¸°
    input.value = '';

    // ì „ì†¡ ë²„íŠ¼ ë¹„í™œì„±í™”
    const sendBtn = document.getElementById('chat-send-btn');
    sendBtn.disabled = true;

    // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
    addChatMessage('user', query);

    // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ
    const loadingId = addTypingIndicator();

    // ìš”ì²­ ì‹œì‘ ì‹œê°„
    const startTime = Date.now();

    // API í˜¸ì¶œ
    google.script.run
      .withSuccessHandler(function (result) {
        removeTypingIndicator(loadingId);
        sendBtn.disabled = false;

        const latency = Date.now() - startTime;

        if (result.success) {
          // ì„¸ì…˜ ID ì €ì¥
          if (result.data.session_id && !State.chatSessionId) {
            State.chatSessionId = result.data.session_id;
            google.script.run.saveChatSessionId(result.data.session_id);
          }

          // ì‘ë‹µ ë©”ì‹œì§€ í‘œì‹œ (ë©”íƒ€ë°ì´í„° í¬í•¨)
          const metadata = {
            latency: latency,
            model: result.data.model || 'solar-pro',
            tokensUsed: result.data.usage?.total_tokens || null
          };
          addChatMessage('assistant', result.data.answer, false, result.data.sources, metadata);

          // ì±„íŒ… ê¸°ë¡ì— ì¶”ê°€
          State.chatHistory.push({ role: 'user', content: query });
          State.chatHistory.push({
            role: 'assistant',
            content: result.data.answer,
            sources: result.data.sources
          });
        } else {
          // ì—ëŸ¬ ê°ì²´ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
          let errorMsg = result.error;
          if (typeof errorMsg === 'object') {
            errorMsg = errorMsg.detail || errorMsg.message || JSON.stringify(errorMsg);
          }
          addChatMessage('assistant', 'âš ï¸ ì˜¤ë¥˜: ' + errorMsg);
          showToast('API í˜¸ì¶œ ì‹¤íŒ¨', 'error');
          console.error('[Council-AI] Chat error:', result);
        }
      })
      .withFailureHandler(function (error) {
        removeTypingIndicator(loadingId);
        sendBtn.disabled = false;
        let errorMsg = error.message || (typeof error === 'object' ? JSON.stringify(error) : error);
        addChatMessage('assistant', 'âš ï¸ ì˜¤ë¥˜: ' + errorMsg);
        showToast('ì„œë²„ ì˜¤ë¥˜', 'error');
        console.error('[Council-AI] Chat failure:', error);
      })
      .apiChat(query, State.chatSessionId, 4, { max_results: 5, include_sources: true });
  }

  function addTypingIndicator() {
    const container = document.getElementById('chat-history');
    const messageId = 'typing-' + Date.now();

    // ì›°ì»´ ë©”ì‹œì§€ ì œê±°
    const welcome = container.querySelector('.text-center');
    if (welcome) {
      welcome.remove();
    }

    const div = document.createElement('div');
    div.id = messageId;
    div.className = 'flex justify-start';

    div.innerHTML = `
    <div class="max-w-[85%] bg-gray-100 rounded-2xl rounded-bl-sm px-4 py-2">
      <div class="typing-indicator">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  `;

    container.appendChild(div);
    container.scrollTop = container.scrollHeight;

    return messageId;
  }

  function removeTypingIndicator(messageId) {
    const msg = document.getElementById(messageId);
    if (msg) {
      msg.remove();
    }
  }

  function addChatMessage(role, content, isLoading, sources, metadata) {
    const container = document.getElementById('chat-history');
    const messageId = 'msg-' + Date.now();

    // ì›°ì»´ ë©”ì‹œì§€ ì œê±°
    const welcome = container.querySelector('.text-center');
    if (welcome) {
      welcome.remove();
    }

    const div = document.createElement('div');
    div.id = messageId;
    div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

    const bubble = document.createElement('div');
    bubble.className = role === 'user'
      ? 'max-w-[85%] bg-google-blue text-white rounded-2xl rounded-br-sm px-4 py-2'
      : 'max-w-[85%] bg-gray-100 text-gray-800 rounded-2xl rounded-bl-sm px-4 py-2 chat-message';

    if (isLoading) {
      bubble.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
    } else {
      // Markdown ë Œë”ë§ (ë´‡ ì‘ë‹µë§Œ)
      if (role === 'assistant' && typeof marked !== 'undefined') {
        let html = marked.parse(content);
        // ì½”ë“œ ë¸”ë¡ì— ì–¸ì–´ ë¼ë²¨ê³¼ ë³µì‚¬ ë²„íŠ¼ ì¶”ê°€
        html = enhanceCodeBlocks(html);
        bubble.innerHTML = html;
      } else {
        bubble.textContent = content;
      }

      // ì†ŒìŠ¤ ë§í¬ ì¶”ê°€ (ê°œì„ ëœ UX)
      if (sources && sources.length > 0) {
        const sourcesWrapper = document.createElement('div');
        sourcesWrapper.className = 'mt-3 pt-2 border-t border-gray-200';

        // í† ê¸€ ë²„íŠ¼
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'sources-toggle';
        toggleBtn.innerHTML = `<span>ğŸ“š ì°¸ê³  ë¬¸ì„œ (${sources.length}ê°œ)</span><span class="arrow">â–¼</span>`;

        // ì†ŒìŠ¤ ì»¨í…Œì´ë„ˆ
        const sourcesContainer = document.createElement('div');
        sourcesContainer.className = 'sources-container mt-2';

        sources.forEach(function (src) {
          const sourceItem = document.createElement('div');
          sourceItem.className = 'source-item';

          // ê´€ë ¨ë„ ì ìˆ˜ ê³„ì‚° (0-1 â†’ í¼ì„¼íŠ¸)
          const score = src.relevance_score || src.score || 0;
          const scorePercent = Math.round(score * 100);
          const scoreClass = scorePercent >= 80 ? 'high' : scorePercent >= 50 ? 'medium' : 'low';

          // ë¬¸ì„œ ì œëª©
          const title = src.document_title || src.document_name || src.title || 'Document';
          // GAS í™˜ê²½ì—ì„œ '#'ëŠ” ERR_FAILEDë¥¼ ìœ ë°œí•˜ë¯€ë¡œ javascript:void(0) ì‚¬ìš©
          const driveLink = src.drive_link || src.url || 'javascript:void(0)';

          sourceItem.innerHTML = `
          <a href="${driveLink}" target="_blank" class="source-link">${escapeHtml(title)}</a>
          <span class="source-score ${scoreClass}">${scorePercent}%</span>
          ${src.section_header ? `<div class="source-section">ğŸ“‘ ${escapeHtml(src.section_header)}</div>` : ''}
        `;

          sourcesContainer.appendChild(sourceItem);
        });

        // í† ê¸€ ì´ë²¤íŠ¸
        toggleBtn.addEventListener('click', function () {
          this.classList.toggle('expanded');
          sourcesContainer.classList.toggle('expanded');
        });

        sourcesWrapper.appendChild(toggleBtn);
        sourcesWrapper.appendChild(sourcesContainer);
        bubble.appendChild(sourcesWrapper);
      }

      // ë©”íƒ€ë°ì´í„° í‘œì‹œ (ë´‡ ì‘ë‹µë§Œ)
      if (role === 'assistant' && metadata) {
        const metaDiv = document.createElement('div');
        metaDiv.className = 'chat-meta';

        const metaParts = [];
        if (metadata.latency) {
          metaParts.push(`â±ï¸ ${(metadata.latency / 1000).toFixed(1)}s`);
        }
        if (metadata.model) {
          metaParts.push(`ğŸ¤– ${metadata.model}`);
        }
        if (metadata.tokensUsed) {
          metaParts.push(`ğŸ“Š ${metadata.tokensUsed} tokens`);
        }

        metaDiv.textContent = metaParts.join(' â€¢ ');
        bubble.appendChild(metaDiv);
      }
    }

    div.appendChild(bubble);
    container.appendChild(div);

    // ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ
    container.scrollTop = container.scrollHeight;

    return messageId;
  }

  // ì½”ë“œ ë¸”ë¡ ê°œì„  í•¨ìˆ˜
  function enhanceCodeBlocks(html) {
    // <pre><code class="language-xxx"> íŒ¨í„´ ì°¾ê¸°
    return html.replace(/<pre><code class="language-(\w+)">/g, function (match, lang) {
      return `<pre><span class="code-lang">${lang}</span><button class="copy-btn" onclick="copyCode(this)">ğŸ“‹ Copy</button><code class="language-${lang} hljs">`;
    }).replace(/<pre><code>/g, function () {
      return '<pre><button class="copy-btn" onclick="copyCode(this)">ğŸ“‹ Copy</button><code class="hljs">';
    });
  }

  // ì½”ë“œ ë³µì‚¬ í•¨ìˆ˜
  function copyCode(btn) {
    const pre = btn.parentElement;
    const code = pre.querySelector('code');
    const text = code.textContent;

    navigator.clipboard.writeText(text).then(function () {
      const originalText = btn.textContent;
      btn.textContent = 'âœ“ Copied!';
      setTimeout(function () {
        btn.textContent = originalText;
      }, 2000);
    }).catch(function (err) {
      showToast('ë³µì‚¬ ì‹¤íŒ¨: ' + err, 'error');
    });
  }

  function removeChatMessage(messageId) {
    const msg = document.getElementById(messageId);
    if (msg) {
      msg.remove();
    }
  }

  function clearChat() {
    if (!confirm('ëŒ€í™” ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      return;
    }

    const container = document.getElementById('chat-history');
    container.innerHTML = `
    <div class="text-center text-gray-500 py-8">
      <span class="text-4xl block mb-2">ğŸ¤–</span>
      <p class="text-sm">í•™ìƒíšŒ ë¬¸ì„œì— ëŒ€í•´ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”!</p>
      <p class="text-xs text-gray-400 mt-1">ì˜ˆ: "2024ë…„ ì¶•ì œ ì˜ˆì‚°ì€ ì–¼ë§ˆì˜€ë‚˜ìš”?"</p>
    </div>
  `;

    // ì„¸ì…˜ ì‚­ì œ
    if (State.chatSessionId) {
      google.script.run.apiDeleteChatHistory(State.chatSessionId);
      google.script.run.deleteUserProperty('chat_session_id');
      State.chatSessionId = null;
    }

    showToast('ëŒ€í™”ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
  }

  // ============================================
  // Docs Tab (Smart Minutes)
  // ============================================
  let minutesStartTime = null;
  let minutesTimerInterval = null;

  function initDocsTab() {
    // í…œí”Œë¦¿ ê²€ì‚¬ ë²„íŠ¼
    document.getElementById('inspect-template-btn').addEventListener('click', inspectTemplate);

    // í…œí”Œë¦¿ ID ë³€ê²½ ì‹œ ê²€ì‚¬ ë²„íŠ¼ í™œì„±í™”
    document.getElementById('template-doc-id').addEventListener('input', function () {
      document.getElementById('inspect-template-btn').disabled = !this.value;
    });

    // ê²°ê³¼ì§€ ìƒì„± ë²„íŠ¼
    document.getElementById('generate-minutes-btn').addEventListener('click', generateMinutes);

    // ë§í¬ ë³µì‚¬ ë²„íŠ¼
    document.getElementById('minutes-copy-link-btn')?.addEventListener('click', function () {
      const link = document.getElementById('minutes-result-link').href;
      copyToClipboard(link, 'ê²°ê³¼ì§€ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });

    // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë³¸ê°’
    document.getElementById('meeting-date').valueAsDate = new Date();
  }

  function inspectTemplate() {
    const templateId = document.getElementById('template-doc-id').value;
    if (!templateId) {
      showToast('í…œí”Œë¦¿ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
      return;
    }

    showLoading(true, 'í…œí”Œë¦¿ ê²€ì‚¬ ì¤‘...');

    google.script.run
      .withSuccessHandler(function (result) {
        showLoading(false);

        if (result.success) {
          const placeholders = result.uniqueNames;
          if (placeholders.length > 0) {
            alert('ğŸ“‹ ë°œê²¬ëœ Placeholder (' + placeholders.length + 'ê°œ):\n\n' + placeholders.map(p => 'â€¢ {{' + p + '}}').join('\n'));
          } else {
            alert('âš ï¸ Placeholderê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\ní…œí”Œë¦¿ì— {{report_1_result}} í˜•ì‹ì˜ placeholderë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
          }
        } else {
          showToast('í…œí”Œë¦¿ ê²€ì‚¬ ì‹¤íŒ¨: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function (error) {
        showLoading(false);
        showToast('ì˜¤ë¥˜: ' + error.message, 'error');
      })
      .extractPlaceholders(templateId);
  }

  function generateMinutes() {
    const agendaDocId = document.getElementById('agenda-doc-id').value;
    const transcriptDocId = document.getElementById('transcript-doc-id').value;
    const templateDocId = document.getElementById('template-doc-id').value;
    const meetingName = document.getElementById('meeting-name').value;
    const meetingDate = document.getElementById('meeting-date').value;
    const outputFolderId = document.getElementById('output-folder-id').value;

    // ìœ íš¨ì„± ê²€ì‚¬
    if (!agendaDocId) {
      showToast('ì•ˆê±´ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
      return;
    }
    // ì†ê¸°ë¡ í•„ìˆ˜ ê²€ì‚¬
    if (!transcriptDocId || transcriptDocId.trim() === '') {
      showToast('ì†ê¸°ë¡ ë¬¸ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. (í•„ìˆ˜)', 'warning');
      return;
    }
    if (!meetingName) {
      showToast('íšŒì˜ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
      return;
    }
    if (!meetingDate) {
      showToast('íšŒì˜ì¼ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
      return;
    }

    // ë²„íŠ¼ ë¹„í™œì„±í™”
    const btn = document.getElementById('generate-minutes-btn');
    setButtonLoading(btn, true);

    // ì§„í–‰ ìƒíƒœ í‘œì‹œ
    const progressEl = document.getElementById('minutes-progress');
    const resultEl = document.getElementById('minutes-result');
    progressEl.classList.remove('hidden');
    resultEl.classList.add('hidden');

    // íƒ€ì´ë¨¸ ì‹œì‘
    minutesStartTime = Date.now();
    startElapsedTimer('minutes');

    // ë‹¨ê³„ ì´ˆê¸°í™”
    resetProgressSteps('minutes');
    updateProgressStep('minutes', 'parse', 'active');
    updateProgress('minutes', 5, 'ë¬¸ì„œ íŒŒì‹± ì¤‘...');

    // API í˜¸ì¶œ
    google.script.run
      .withSuccessHandler(function (result) {
        if (result.success) {
          // Polling ì‹œì‘
          startPolling('minutes', result.data.task_id, function (status) {
            handleMinutesStatus(status, btn);
          });
        } else {
          stopElapsedTimer('minutes');
          setButtonLoading(btn, false);
          progressEl.classList.add('hidden');
          showToast('ìš”ì²­ ì‹¤íŒ¨: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function (error) {
        stopElapsedTimer('minutes');
        setButtonLoading(btn, false);
        progressEl.classList.add('hidden');
        showToast('ì˜¤ë¥˜: ' + error.message, 'error');
      })
      .apiGenerateMinutes({
        agendaDocId: agendaDocId,
        transcriptDocId: transcriptDocId || null,
        templateDocId: templateDocId || null,
        meetingName: meetingName,
        meetingDate: meetingDate,
        outputFolderId: outputFolderId || null
      });
  }

  function handleMinutesStatus(status, btn) {
    const progress = status.progress || 0;
    const step = status.step || status.status;

    updateProgress('minutes', progress, step);

    // ë‹¨ê³„ë³„ UI ì—…ë°ì´íŠ¸
    if (progress >= 10) updateProgressStep('minutes', 'parse', 'completed');
    if (progress >= 25) updateProgressStep('minutes', 'analyze', 'active');
    if (progress >= 40) {
      updateProgressStep('minutes', 'analyze', 'completed');
      updateProgressStep('minutes', 'generate', 'active');
    }
    if (progress >= 80) {
      updateProgressStep('minutes', 'generate', 'completed');
      updateProgressStep('minutes', 'finalize', 'active');
    }

    if (status.status === 'SUCCESS') {
      stopPolling('minutes');
      stopElapsedTimer('minutes');
      setButtonLoading(btn, false);

      // ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ í‘œì‹œ
      updateProgressStep('minutes', 'finalize', 'completed');

      document.getElementById('minutes-progress').classList.add('hidden');
      const resultEl = document.getElementById('minutes-result');
      resultEl.classList.remove('hidden');

      const link = document.getElementById('minutes-result-link');
      const outputLink = status.result?.output_doc_link || status.output_doc_link || '#';
      link.href = outputLink;

      // ì†Œìš” ì‹œê°„ í‘œì‹œ
      const elapsed = Math.round((Date.now() - minutesStartTime) / 1000);
      document.getElementById('minutes-result-time').textContent = `ì†Œìš” ì‹œê°„: ${formatElapsedTime(elapsed)}`;

      showToast('ê²°ê³¼ì§€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    } else if (status.status === 'FAILURE') {
      stopPolling('minutes');
      stopElapsedTimer('minutes');
      setButtonLoading(btn, false);
      document.getElementById('minutes-progress').classList.add('hidden');

      showToast('ìƒì„± ì‹¤íŒ¨: ' + (status.error || 'Unknown error'), 'error');
      alert('âŒ ìƒì„± ì‹¤íŒ¨\n\n' + (status.error || 'Unknown error'));
    }
  }

  // ============================================
  // Calendar Tab
  // ============================================
  let extractedTodos = [];

  function initCalendarTab() {
    document.getElementById('extract-todos-btn').addEventListener('click', extractTodos);
    document.getElementById('register-todos-btn').addEventListener('click', registerTodos);
    document.getElementById('select-all-todos').addEventListener('change', toggleAllTodos);
    
    // ìº˜ë¦°ë” ê¶Œí•œ í™•ì¸ ë²„íŠ¼
    document.getElementById('check-calendar-access-btn').addEventListener('click', checkCalendarAccess);
  }

  /**
   * ì„ íƒí•œ ìº˜ë¦°ë”ì— ëŒ€í•œ ì“°ê¸° ê¶Œí•œ í™•ì¸
   */
  function checkCalendarAccess() {
    const calendarId = document.getElementById('target-calendar-id').value;
    const btn = document.getElementById('check-calendar-access-btn');
    const originalText = btn.textContent;
    btn.textContent = 'í™•ì¸ ì¤‘...';
    btn.disabled = true;

    google.script.run
      .withSuccessHandler(function(result) {
        btn.textContent = originalText;
        btn.disabled = false;
        
        if (result.success) {
          if (result.canWrite) {
            showToast(`âœ… "${result.calendarName}" ìº˜ë¦°ë”ì— ì“°ê¸° ê¶Œí•œì´ ìˆìŠµë‹ˆë‹¤. (${result.accessLevel})`, 'success');
          } else {
            showToast(`âš ï¸ "${result.calendarName}" ìº˜ë¦°ë”ì— ì“°ê¸° ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (${result.accessLevel})`, 'warning');
          }
        } else {
          showToast('âŒ ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        btn.textContent = originalText;
        btn.disabled = false;
        showToast('ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨: ' + error.message, 'error');
      })
      .checkCalendarAccess(calendarId);
  }

  function extractTodos() {
    const sourceDocId = document.getElementById('calendar-source-doc-id').value;

    if (!sourceDocId) {
      showToast('ê²°ê³¼ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
      return;
    }

    const btn = document.getElementById('extract-todos-btn');
    setButtonLoading(btn, true);

    // ì§„í–‰ ìƒíƒœ í‘œì‹œ
    document.getElementById('extract-progress').classList.remove('hidden');
    document.getElementById('todos-section').classList.add('hidden');
    document.getElementById('register-result').classList.add('hidden');

    google.script.run
      .withSuccessHandler(function (result) {
        setButtonLoading(btn, false);
        document.getElementById('extract-progress').classList.add('hidden');

        if (result.success) {
          extractedTodos = result.data.todos || [];
          const count = result.data.total_count || extractedTodos.length;

          renderTodos(extractedTodos);
          document.getElementById('todos-section').classList.remove('hidden');
          document.getElementById('todos-count').textContent = count;
          updateSelectedCount();

          showToast('í• ì¼ ' + count + 'ê°œ ì¶”ì¶œ ì™„ë£Œ', 'success');
        } else {
          showToast('ì¶”ì¶œ ì‹¤íŒ¨: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function (error) {
        setButtonLoading(btn, false);
        document.getElementById('extract-progress').classList.add('hidden');
        showToast('ì˜¤ë¥˜: ' + error.message, 'error');
      })
      .apiExtractTodos(sourceDocId, true);
  }

  function renderTodos(todos) {
    const container = document.getElementById('todos-list');
    container.innerHTML = '';

    if (todos.length === 0) {
      container.innerHTML = '<p class="text-center text-gray-500 py-4">ì¶”ì¶œëœ í• ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    todos.forEach(function (todo, index) {
      const card = document.createElement('div');
      card.className = 'todo-card bg-white border border-gray-200 rounded-lg p-3';
      card.dataset.index = index;

      // ë‚ ì§œê°€ ê³¼ê±°ì¸ì§€ í™•ì¸
      const isPastDate = todo.parsed_date && new Date(todo.parsed_date) < new Date();
      const dateWarning = isPastDate ? '<span class="text-xs text-orange-500 ml-1">(ê³¼ê±°)</span>' : '';

      card.innerHTML = `
      <div class="flex items-start gap-2 mb-2">
        <input type="checkbox" class="todo-checkbox mt-1 rounded" checked data-index="${index}">
        <div class="flex-1">
          <input type="text" class="todo-summary w-full border-b border-transparent hover:border-gray-300 focus:border-google-blue focus:outline-none text-sm font-medium" value="${escapeHtml(todo.content)}" data-field="summary">
        </div>
      </div>
      <div class="grid grid-cols-2 gap-2 ml-6">
        <div>
          <label class="text-xs text-gray-500">ë‚ ì§œ ${dateWarning}</label>
          <input type="date" class="todo-date w-full border border-gray-200 rounded px-2 py-1 text-xs ${isPastDate ? 'border-orange-300' : ''}" value="${todo.parsed_date || ''}" data-field="date">
        </div>
        <div>
          <label class="text-xs text-gray-500">ë‹´ë‹¹ì (ì´ë©”ì¼)</label>
          <input type="email" class="todo-assignee w-full border border-gray-200 rounded px-2 py-1 text-xs" placeholder="email@example.com" value="${todo.assignee || ''}" data-field="assignee">
        </div>
      </div>
      ${todo.context ? `<p class="text-xs text-gray-400 mt-2 ml-6 truncate" title="${escapeHtml(todo.context)}">${escapeHtml(todo.context)}</p>` : ''}
    `;

      // ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì´ë²¤íŠ¸
      card.querySelector('.todo-checkbox').addEventListener('change', updateSelectedCount);

      container.appendChild(card);
    });

    updateSelectedCount();
  }

  function toggleAllTodos(e) {
    const checked = e.target.checked;
    document.querySelectorAll('.todo-checkbox').forEach(function (cb) {
      cb.checked = checked;
    });
    updateSelectedCount();
  }

  function updateSelectedCount() {
    const total = document.querySelectorAll('.todo-checkbox').length;
    const selected = document.querySelectorAll('.todo-checkbox:checked').length;

    const countEl = document.getElementById('selected-todos-count');
    if (countEl) {
      countEl.textContent = selected;
    }

    // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë™ê¸°í™”
    const selectAllEl = document.getElementById('select-all-todos');
    if (selectAllEl) {
      selectAllEl.checked = selected === total && total > 0;
      selectAllEl.indeterminate = selected > 0 && selected < total;
    }

    // ë“±ë¡ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
    const registerBtn = document.getElementById('register-todos-btn');
    if (registerBtn) {
      registerBtn.disabled = selected === 0;
    }
  }

  function registerTodos() {
    const cards = document.querySelectorAll('.todo-card');
    const todosToRegister = [];
    const invalidItems = [];
    
    // ëŒ€ìƒ ìº˜ë¦°ë” ID ê°€ì ¸ì˜¤ê¸°
    const calendarId = document.getElementById('target-calendar-id').value;

    cards.forEach(function (card) {
      const checkbox = card.querySelector('.todo-checkbox');
      if (!checkbox.checked) return;

      const summary = card.querySelector('.todo-summary').value.trim();
      const date = card.querySelector('.todo-date').value;
      const assignee = card.querySelector('.todo-assignee').value.trim();
      const index = parseInt(card.dataset.index);

      // ìœ íš¨ì„± ê²€ì‚¬
      if (!summary) {
        invalidItems.push({ index, reason: 'í• ì¼ ë‚´ìš©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.' });
        return;
      }
      if (!date) {
        invalidItems.push({ index, reason: 'ë‚ ì§œê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' });
        return;
      }
      if (assignee && !isValidEmail(assignee)) {
        invalidItems.push({ index, reason: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.' });
        return;
      }

      todosToRegister.push({
        index: index,
        summary: summary,
        dtStart: date + 'T09:00:00',
        dtEnd: date + 'T10:00:00',
        assigneeEmail: assignee || null,
        description: 'Council-AIì—ì„œ ì¶”ì¶œëœ í• ì¼',
        calendarId: calendarId  // ëŒ€ìƒ ìº˜ë¦°ë” ID ì¶”ê°€
      });
    });

    // ìœ íš¨í•˜ì§€ ì•Šì€ í•­ëª© ê²½ê³ 
    if (invalidItems.length > 0) {
      const warnings = invalidItems.map(item => `â€¢ í•­ëª© ${item.index + 1}: ${item.reason}`).join('\n');
      alert('âš ï¸ ë‹¤ìŒ í•­ëª©ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤:\n\n' + warnings + '\n\ní•´ë‹¹ í•­ëª©ì€ ì œì™¸í•˜ê³  ë“±ë¡í•©ë‹ˆë‹¤.');
    }

    if (todosToRegister.length === 0) {
      showToast('ë“±ë¡í•  ìœ íš¨í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
      return;
    }

    const btn = document.getElementById('register-todos-btn');
    setButtonLoading(btn, true);

    // ì§„í–‰ ìƒíƒœ UI í‘œì‹œ
    const progressEl = document.getElementById('register-progress');
    const resultEl = document.getElementById('register-result');
    progressEl.classList.remove('hidden');
    resultEl.classList.add('hidden');

    const total = todosToRegister.length;
    let completed = 0;
    let succeeded = 0;
    let failed = 0;
    const failedItems = [];

    function updateRegisterProgress() {
      const progress = Math.round((completed / total) * 100);
      document.getElementById('register-progress-bar').style.width = progress + '%';
      document.getElementById('register-progress-count').textContent = `${completed}/${total}`;
      document.getElementById('register-status-text').textContent = `ë“±ë¡ ì¤‘... (${completed}/${total})`;
    }

    function registerNext(index) {
      if (index >= todosToRegister.length) {
        // ì™„ë£Œ
        setButtonLoading(btn, false);
        progressEl.classList.add('hidden');
        resultEl.classList.remove('hidden');

        document.getElementById('register-success-count').textContent = succeeded;
        document.getElementById('register-fail-count').textContent = failed;

        // ì„±ê³µí•œ í•­ëª© ì²´í¬ í•´ì œ (ì‹œê°ì  í”¼ë“œë°±)
        todosToRegister.forEach(function (todo) {
          if (!failedItems.includes(todo.index)) {
            const card = document.querySelector(`.todo-card[data-index="${todo.index}"]`);
            if (card) {
              card.classList.add('bg-green-50', 'border-green-200');
              card.querySelector('.todo-checkbox').checked = false;
            }
          }
        });

        updateSelectedCount();

        if (failed > 0) {
          showToast(`${succeeded}ê°œ ì„±ê³µ, ${failed}ê°œ ì‹¤íŒ¨`, 'warning');
        } else {
          showToast(`${succeeded}ê°œ ìº˜ë¦°ë”ì— ë“±ë¡ ì™„ë£Œ!`, 'success');
        }
        return;
      }

      const todo = todosToRegister[index];

      google.script.run
        .withSuccessHandler(function (result) {
          completed++;
          if (result.success) {
            succeeded++;
            console.log('[Calendar] ì´ë²¤íŠ¸ ìƒì„± ì„±ê³µ:', result);
          } else {
            failed++;
            failedItems.push(todo.index);
            // ì‹¤íŒ¨ ì´ìœ  í‘œì‹œ (ê¶Œí•œ ì—†ìŒ ë“±)
            console.error('[Calendar] ì´ë²¤íŠ¸ ìƒì„± ì‹¤íŒ¨:', result.error);
            if (result.error && result.error.includes('ì“°ê¸° ê¶Œí•œ')) {
              showToast('âš ï¸ ìº˜ë¦°ë” ì“°ê¸° ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ìº˜ë¦°ë” ê´€ë¦¬ìì—ê²Œ ê¶Œí•œì„ ìš”ì²­í•˜ì„¸ìš”.', 'error');
            }
          }
          updateRegisterProgress();
          registerNext(index + 1);
        })
        .withFailureHandler(function (error) {
          completed++;
          failed++;
          failedItems.push(todo.index);
          updateRegisterProgress();
          registerNext(index + 1);
        })
        .apiCreateCalendarEvent(todo);
    }

    updateRegisterProgress();
    registerNext(0);
  }

  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  // ============================================
  // Admin Tab
  // ============================================
  let handoverStartTime = null;

  function initAdminTab() {
    document.getElementById('start-ingest-btn').addEventListener('click', startIngestion);
    document.getElementById('generate-handover-btn').addEventListener('click', generateHandover);
    document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
    document.getElementById('refresh-docs-btn').addEventListener('click', loadDocuments);

    // ì¸ìˆ˜ì¸ê³„ì„œ ë§í¬ ë³µì‚¬ ë²„íŠ¼
    document.getElementById('handover-copy-link-btn')?.addEventListener('click', function () {
      const link = document.getElementById('handover-result-link').href;
      copyToClipboard(link, 'ì¸ìˆ˜ì¸ê³„ì„œ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });
  }

  function startIngestion() {
    const folderId = document.getElementById('ingest-folder-id').value;

    if (!folderId) {
      showToast('í•™ìŠµ í´ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
      return;
    }

    const btn = document.getElementById('start-ingest-btn');
    setButtonLoading(btn, true);

    const progressEl = document.getElementById('ingest-progress');
    progressEl.classList.remove('hidden');
    document.getElementById('ingest-status-text').textContent = 'í•™ìŠµ ì‹œì‘ ì¤‘...';

    google.script.run
      .withSuccessHandler(function (result) {
        if (result.success) {
          startPolling('ingest', result.data.task_id, function (status) {
            document.getElementById('ingest-status-text').textContent = status.step || status.status;

            if (status.status === 'SUCCESS') {
              stopPolling('ingest');
              setButtonLoading(btn, false);
              progressEl.classList.add('hidden');
              showToast('ìë£Œ í•™ìŠµì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
              loadDocuments();
            } else if (status.status === 'FAILURE') {
              stopPolling('ingest');
              setButtonLoading(btn, false);
              progressEl.classList.add('hidden');
              showToast('í•™ìŠµ ì‹¤íŒ¨: ' + status.error, 'error');
            }
          });
        } else {
          setButtonLoading(btn, false);
          progressEl.classList.add('hidden');
          showToast('ìš”ì²­ ì‹¤íŒ¨: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function (error) {
        setButtonLoading(btn, false);
        progressEl.classList.add('hidden');
        showToast('ì˜¤ë¥˜: ' + error.message, 'error');
      })
      .apiIngestFolder(folderId, { recursive: true }, 2);
  }

  function generateHandover() {
    const year = parseInt(document.getElementById('handover-year').value);
    const department = document.getElementById('handover-department').value;
    const folderId = document.getElementById('handover-folder-id').value;

    // ìœ íš¨ì„± ê²€ì‚¬
    if (!year || isNaN(year)) {
      showToast('ëŒ€ìƒ ì—°ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
      return;
    }

    const btn = document.getElementById('generate-handover-btn');
    setButtonLoading(btn, true);

    const progressEl = document.getElementById('handover-progress');
    const resultEl = document.getElementById('handover-result');
    progressEl.classList.remove('hidden');
    resultEl.classList.add('hidden');

    // íƒ€ì´ë¨¸ ì‹œì‘
    handoverStartTime = Date.now();
    startElapsedTimer('handover');

    // ë‹¨ê³„ ì´ˆê¸°í™”
    resetProgressSteps('handover');
    updateProgressStep('handover', 'collect', 'active');
    updateProgress('handover', 5, 'ê´€ë ¨ ë¬¸ì„œ ìˆ˜ì§‘ ì¤‘...');

    google.script.run
      .withSuccessHandler(function (result) {
        if (result.success) {
          startPolling('handover', result.data.task_id, function (status) {
            handleHandoverStatus(status, btn);
          });
        } else {
          stopElapsedTimer('handover');
          setButtonLoading(btn, false);
          progressEl.classList.add('hidden');
          showToast('ìš”ì²­ ì‹¤íŒ¨: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function (error) {
        stopElapsedTimer('handover');
        setButtonLoading(btn, false);
        progressEl.classList.add('hidden');
        showToast('ì˜¤ë¥˜: ' + error.message, 'error');
      })
      .apiGenerateHandover({
        targetYear: year,
        department: department || null,
        targetFolderId: folderId || null
      });
  }

  function handleHandoverStatus(status, btn) {
    const progress = status.progress || 0;
    const step = status.step || status.status;

    updateProgress('handover', progress, step);

    // ë‹¨ê³„ë³„ UI ì—…ë°ì´íŠ¸
    if (progress >= 10) updateProgressStep('handover', 'collect', 'completed');
    if (progress >= 25) updateProgressStep('handover', 'summarize', 'active');
    if (progress >= 50) {
      updateProgressStep('handover', 'summarize', 'completed');
      updateProgressStep('handover', 'generate', 'active');
    }
    if (progress >= 80) {
      updateProgressStep('handover', 'generate', 'completed');
      updateProgressStep('handover', 'finalize', 'active');
    }

    if (status.status === 'SUCCESS') {
      stopPolling('handover');
      stopElapsedTimer('handover');
      setButtonLoading(btn, false);

      // ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ í‘œì‹œ
      updateProgressStep('handover', 'finalize', 'completed');

      document.getElementById('handover-progress').classList.add('hidden');
      const resultEl = document.getElementById('handover-result');
      resultEl.classList.remove('hidden');

      const link = document.getElementById('handover-result-link');
      const outputLink = status.result?.output_doc_link || status.output_doc_link || '#';
      link.href = outputLink;

      // ì†Œìš” ì‹œê°„ í‘œì‹œ
      const elapsed = Math.round((Date.now() - handoverStartTime) / 1000);
      document.getElementById('handover-result-time').textContent = `ì†Œìš” ì‹œê°„: ${formatElapsedTime(elapsed)}`;

      showToast('ì¸ìˆ˜ì¸ê³„ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    } else if (status.status === 'FAILURE') {
      stopPolling('handover');
      stopElapsedTimer('handover');
      setButtonLoading(btn, false);
      document.getElementById('handover-progress').classList.add('hidden');
      showToast('ìƒì„± ì‹¤íŒ¨: ' + status.error, 'error');
    }
  }

  function loadSettings() {
    google.script.run
      .withSuccessHandler(function (settings) {
        if (settings.apiBaseUrl) {
          document.getElementById('settings-api-url').value = settings.apiBaseUrl;
        }
        document.getElementById('settings-status').textContent =
          settings.hasApiKey ? 'âœ… API Key ì„¤ì •ë¨' : 'âš ï¸ API Key ë¯¸ì„¤ì •';
      })
      .getAdminSettings();
  }

  function saveSettings() {
    const apiUrl = document.getElementById('settings-api-url').value;
    const apiKey = document.getElementById('settings-api-key').value;
    const pickerKey = document.getElementById('settings-picker-key').value;

    const btn = document.getElementById('save-settings-btn');
    setButtonLoading(btn, true);

    google.script.run
      .withSuccessHandler(function (result) {
        setButtonLoading(btn, false);

        if (result.success) {
          showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          loadSettings();

          // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
          document.getElementById('settings-api-key').value = '';
          document.getElementById('settings-picker-key').value = '';
        } else {
          showToast('ì €ì¥ ì‹¤íŒ¨: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function (error) {
        setButtonLoading(btn, false);
        showToast('ì˜¤ë¥˜: ' + error.message, 'error');
      })
      .saveAdminSettings({
        apiBaseUrl: apiUrl,
        apiKey: apiKey || null,
        pickerApiKey: pickerKey || null
      });
  }

  function loadDocuments() {
    const container = document.getElementById('documents-list');
    container.innerHTML = '<p class="text-xs text-gray-500 text-center py-4">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

    google.script.run
      .withSuccessHandler(function (result) {
        if (result.success && result.data.documents) {
          const docs = result.data.documents;

          if (docs.length === 0) {
            container.innerHTML = '<p class="text-xs text-gray-500 text-center py-4">í•™ìŠµëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
          }

          container.innerHTML = docs.map(function (doc) {
            const statusIcon = doc.status === 'completed' ? 'âœ…' : doc.status === 'processing' ? 'â³' : 'âŒ';
            return `
            <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
              <span class="text-xs truncate flex-1" title="${escapeHtml(doc.name)}">${escapeHtml(doc.name)}</span>
              <span class="text-xs ml-2">${statusIcon}</span>
            </div>
          `;
          }).join('');
        } else {
          container.innerHTML = '<p class="text-xs text-gray-500 text-center py-4">ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
      })
      .withFailureHandler(function () {
        container.innerHTML = '<p class="text-xs text-red-500 text-center py-4">ì˜¤ë¥˜ ë°œìƒ</p>';
      })
      .apiGetDocuments(0, 20);
  }

  // ============================================
  // Google Picker
  // ============================================
  function loadPickerApi() {
    gapi.load('picker', function () {
      State.pickerLoaded = true;
      console.log('[Council-AI] Picker API loaded');
      initPickerButtons();
    });
  }

  function initPickerButtons() {
    document.querySelectorAll('.picker-btn').forEach(function (btn) {
      btn.addEventListener('click', function () {
        const targetInput = this.dataset.target;
        const pickerType = this.dataset.type; // 'doc' or 'folder'
        openPicker(targetInput, pickerType);
      });
    });
  }

  function openPicker(targetInputId, pickerType) {
    if (!State.pickerLoaded) {
      showToast('Picker API ë¡œë”© ì¤‘...', 'warning');
      return;
    }

    google.script.run
      .withSuccessHandler(function (config) {
        State.oauthToken = config.oauthToken;
        State.developerKey = config.developerKey;

        createPicker(targetInputId, pickerType);
      })
      .withFailureHandler(function (error) {
        showToast('Picker ì„¤ì • ì˜¤ë¥˜: ' + error.message, 'error');
      })
      .getPickerConfig();
  }

  function createPicker(targetInputId, pickerType) {
    let view;

    if (pickerType === 'folder') {
      view = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
        .setSelectFolderEnabled(true)
        .setIncludeFolders(true);
    } else {
      view = new google.picker.DocsView(google.picker.ViewId.DOCUMENTS)
        .setMimeTypes('application/vnd.google-apps.document');
    }

    // GAS ì‚¬ì´ë“œë°”ì—ì„œ Pickerë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ì˜¬ë°”ë¥¸ origin ì„¤ì •ì´ í•„ìˆ˜
    // google.script.host.originì€ GAS ì‚¬ì´ë“œë°”ì˜ ì‹¤ì œ originì„ ë°˜í™˜
    const origin = google.script.host.origin;

    const pickerBuilder = new google.picker.PickerBuilder()
      .addView(view)
      .setOAuthToken(State.oauthToken)
      .setOrigin(origin)  // GAS í™˜ê²½ì—ì„œ í•„ìˆ˜!
      .setCallback(function (data) {
        pickerCallback(data, targetInputId);
      });

    // Developer Keyê°€ ìˆìœ¼ë©´ ì¶”ê°€ (ì„ íƒì )
    if (State.developerKey) {
      pickerBuilder.setDeveloperKey(State.developerKey);
    }

    const picker = pickerBuilder.build();
    picker.setVisible(true);
  }

  function pickerCallback(data, targetInputId) {
    if (data.action === google.picker.Action.PICKED) {
      const doc = data.docs[0];

      // ID ì…ë ¥
      document.getElementById(targetInputId).value = doc.id;

      // ì´ë¦„ í‘œì‹œ
      const nameEl = document.getElementById(targetInputId.replace('-id', '-name'));
      if (nameEl) {
        nameEl.textContent = doc.name;
      }

      // í…œí”Œë¦¿ ê²€ì‚¬ ë²„íŠ¼ í™œì„±í™”
      if (targetInputId === 'template-doc-id') {
        document.getElementById('inspect-template-btn').disabled = false;
      }
    }
  }

  // ============================================
  // Polling (ë¹„ë™ê¸° Task ìƒíƒœ í™•ì¸)
  // ============================================
  function startPolling(taskType, taskId, callback) {
    // ê¸°ì¡´ í´ë§ ì¤‘ì§€
    stopPolling(taskType);

    // 1.5ì´ˆ ê°„ê²© í´ë§
    State.pollingIntervals[taskType] = setInterval(function () {
      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            callback(result.data);
          } else {
            callback({ status: 'FAILURE', error: result.error });
          }
        })
        .withFailureHandler(function (error) {
          callback({ status: 'FAILURE', error: error.message });
        })
        .apiGetTaskStatus(taskId);
    }, 1500);
  }

  function stopPolling(taskType) {
    if (State.pollingIntervals[taskType]) {
      clearInterval(State.pollingIntervals[taskType]);
      delete State.pollingIntervals[taskType];
    }
  }

  function updateProgress(taskType, progress, statusText) {
    const progressBar = document.getElementById(taskType + '-progress-bar');
    const statusEl = document.getElementById(taskType + '-status-text');

    if (progressBar) {
      progressBar.style.width = progress + '%';
    }
    if (statusEl) {
      statusEl.textContent = statusText || 'ì²˜ë¦¬ ì¤‘...';
    }
  }

  // ============================================
  // UI ìœ í‹¸ë¦¬í‹°
  // ============================================
  const elapsedTimers = {};

  function showToast(message, type) {
    const container = document.getElementById('toast-container');

    const toast = document.createElement('div');
    toast.className = 'toast-enter px-4 py-3 rounded-lg shadow-lg text-white text-sm max-w-xs';

    switch (type) {
      case 'success':
        toast.classList.add('bg-green-600');
        toast.innerHTML = 'âœ… ' + message;
        break;
      case 'error':
        toast.classList.add('bg-red-600');
        toast.innerHTML = 'âŒ ' + message;
        break;
      case 'warning':
        toast.classList.add('bg-yellow-500');
        toast.innerHTML = 'âš ï¸ ' + message;
        break;
      default:
        toast.classList.add('bg-gray-800');
        toast.innerHTML = 'â„¹ï¸ ' + message;
    }

    container.appendChild(toast);

    // 3ì´ˆ í›„ ì œê±°
    setTimeout(function () {
      toast.classList.remove('toast-enter');
      toast.classList.add('toast-exit');
      setTimeout(function () {
        toast.remove();
      }, 300);
    }, 3000);
  }

  function showLoading(show, text) {
    const overlay = document.getElementById('loading-overlay');
    const textEl = document.getElementById('loading-text');

    if (show) {
      textEl.textContent = text || 'ì²˜ë¦¬ ì¤‘...';
      overlay.classList.remove('hidden');
    } else {
      overlay.classList.add('hidden');
    }
  }

  function setButtonLoading(btn, loading) {
    if (loading) {
      btn.disabled = true;
      btn.dataset.originalHtml = btn.innerHTML;
      btn.innerHTML = '<div class="spinner mx-auto"></div>';
    } else {
      btn.disabled = false;
      if (btn.dataset.originalHtml) {
        btn.innerHTML = btn.dataset.originalHtml;
      }
    }
  }

  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ============================================
  // Progress Step ìœ í‹¸ë¦¬í‹°
  // ============================================

  // ì§„í–‰ ë‹¨ê³„ ì—…ë°ì´íŠ¸
  function updateProgressStep(taskType, stepName, status) {
    const stepsContainer = document.getElementById(taskType + '-steps');
    if (!stepsContainer) return;

    const step = stepsContainer.querySelector(`[data-step="${stepName}"]`);
    if (!step) return;

    const icon = step.querySelector('.step-icon');

    // ì´ì „ ìƒíƒœ ì œê±°
    step.classList.remove('active', 'completed');

    if (status === 'active') {
      step.classList.add('active');
      icon.textContent = 'â³';
    } else if (status === 'completed') {
      step.classList.add('completed');
      icon.textContent = 'âœ…';
    } else {
      icon.textContent = 'â¬œ';
    }
  }

  // ëª¨ë“  ì§„í–‰ ë‹¨ê³„ ì´ˆê¸°í™”
  function resetProgressSteps(taskType) {
    const stepsContainer = document.getElementById(taskType + '-steps');
    if (!stepsContainer) return;

    stepsContainer.querySelectorAll('.step').forEach(function (step) {
      step.classList.remove('active', 'completed');
      const icon = step.querySelector('.step-icon');
      if (icon) icon.textContent = 'â¬œ';
    });
  }

  // ê²½ê³¼ ì‹œê°„ íƒ€ì´ë¨¸ ì‹œì‘
  function startElapsedTimer(taskType) {
    stopElapsedTimer(taskType);

    const timerEl = document.getElementById(taskType + '-elapsed-time');
    if (!timerEl) return;

    const startTime = Date.now();

    elapsedTimers[taskType] = setInterval(function () {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      timerEl.textContent = formatElapsedTime(elapsed);
    }, 1000);
  }

  // ê²½ê³¼ ì‹œê°„ íƒ€ì´ë¨¸ ì¤‘ì§€
  function stopElapsedTimer(taskType) {
    if (elapsedTimers[taskType]) {
      clearInterval(elapsedTimers[taskType]);
      delete elapsedTimers[taskType];
    }
  }

  // ê²½ê³¼ ì‹œê°„ í¬ë§·íŒ…
  function formatElapsedTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  // í´ë¦½ë³´ë“œ ë³µì‚¬
  function copyToClipboard(text, successMessage) {
    navigator.clipboard.writeText(text).then(function () {
      showToast(successMessage || 'ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    }).catch(function (err) {
      showToast('ë³µì‚¬ ì‹¤íŒ¨: ' + err, 'error');
    });
  }
</script>