# Smart Minutes v2.0 vs v2.1 ì‹¬ì¸µ ë¹„êµ ë¶„ì„

## ğŸ” Executive Summary

| ê²€ì¦ í•­ëª©          | ê²°ê³¼        | ì¦ê±°                                                                                                                      |
| ------------------ | ----------- | ------------------------------------------------------------------------------------------------------------------------- |
| Legacy ë¡œì§ íšŒê·€   | âœ… **PASS** | [get_document_text()](file:///c:/Users/imtae/madcamp/2025Winter_4th/backend/app/services/google/docs.py#69-103) í˜¸ì¶œ ì—†ìŒ |
| DB ì¡°íšŒ ì‚¬ìš©       | âœ… **PASS** | `select(Document).where(Document.drive_id == ...)`                                                                        |
| Cloud SQL ì—°ê²°     | âœ… **PASS** | `asyncpg` ë“œë¼ì´ë²„ + Cloud SQL Connector                                                                                  |
| Untitled ë²„ê·¸ ìˆ˜ì • | âœ… **PASS** | `drive_meta.get("name")` ì‚¬ìš©                                                                                             |

---

## 1. Critical Logic Verification

### 1.1 Legacy ë¡œì§ íšŒê·€ ì—¬ë¶€

**ì§ˆë¬¸:** v2.1ì—ì„œ `transcript_doc_id`ë¥¼ Frontendê°€ ì§ì ‘ ë³´ë‚´ë¯€ë¡œ, Backendê°€ ë‹¤ì‹œ `GoogleDocsService.get_document_text()`ë¥¼ í˜¸ì¶œí•˜ëŠ” Legacy ë°©ì‹ìœ¼ë¡œ ëŒì•„ê°”ëŠ”ê°€?

**ë‹µë³€: âŒ ì•„ë‹ˆìš”, Legacyë¡œ ëŒì•„ê°€ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.**

#### ì¦ê±° 1: grep ê²€ìƒ‰ ê²°ê³¼

```bash
$ grep -n "get_document_text" app/tasks/features.py
v2_comparison_report.md# ê²°ê³¼: ì—†ìŒ (0 matches)
```

#### ì¦ê±° 2: ì‹¤ì œ ì½”ë“œ (features.py:124-126)

```python
# v2.1: DB ì¡°íšŒ ë°©ì‹ (RAG ê¸°ë°˜)
async with async_session_factory() as db:
    result = await db.execute(
        select(Document).where(Document.drive_id == drive_id)  # âœ… DB ì¡°íšŒ
    )
    doc = result.scalar_one_or_none()
```

#### ì¦ê±° 3: ë°ì´í„° íë¦„ ì¶”ì 

```
Frontend (Picker)
    â†“ transcript_doc_id: "1ABC..." (Drive ID)
Backend (features.py)
    â†“ SELECT * FROM documents WHERE drive_id = '1ABC...'
PostgreSQL (documents table)
    â†“ doc.preprocessed_content (RAG íŒŒì´í”„ë¼ì¸ ê²°ê³¼ë¬¼)
Gemini API
    â†’ summarize_agenda_section(section.content)
```

**ê²°ë¡ :** `transcript_doc_id`ëŠ” **DB ì¡°íšŒ í‚¤**ë¡œë§Œ ì‚¬ìš©ë˜ë©°, Google Docs API í˜¸ì¶œì— ì§ì ‘ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

---

### 1.2 Source of Truth ì¶”ì 

**ì§ˆë¬¸:** ìš”ì•½(Summarize) ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•˜ëŠ” í…ìŠ¤íŠ¸ê°€ DB(`preprocessed_content`)ì—ì„œ ìœ ë˜í–ˆëŠ”ê°€?

**ë‹µë³€: âœ… ì˜ˆ, DB ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.**

#### ë³€ìˆ˜ ì¶”ì  ì²´ì¸

```python
# Phase 0 (Line 155)
transcript_content, transcript_name, transcript_db_id = run_async(
    _fetch_document_by_drive_id(transcript_doc_id)
)
# â†’ transcript_content = doc.preprocessed_content (Line 152)

# Phase 2 (Line 231)
transcript_sections = split_by_headers(transcript_content, max_level=2)
# â†’ transcript_content ë³€ìˆ˜ ê·¸ëŒ€ë¡œ ì‚¬ìš©

# Phase 2 (Line 255-259)
result = gemini.summarize_agenda_section(
    section_content=section.content,  # â† transcript_sectionsì—ì„œ ë¶„í• ëœ ë‚´ìš©
    section_title=section.title,
    agenda_type=agenda_type,
)
```

---

## 2. Infrastructure Verification

### 2.1 Cloud SQL ì—°ê²° í™•ì¸

**database.py ë¶„ì„:**

```python
# Line 20-42: Cloud SQL Connector ì‚¬ìš© (Production)
if settings.USE_CLOUD_SQL and settings.CLOUD_SQL_CONNECTION_NAME:
    from google.cloud.sql.connector import Connector
    connector = Connector()

    async def getconn():
        conn = await connector.connect_async(
            settings.CLOUD_SQL_CONNECTION_NAME,  # e.g. "project:region:instance"
            "asyncpg",  # âœ… PostgreSQL ë“œë¼ì´ë²„
            user=settings.POSTGRES_USER,
            password=settings.POSTGRES_PASSWORD,
            db=settings.POSTGRES_DB,
        )
        return conn

    return create_async_engine(
        "postgresql+asyncpg://",  # âœ… asyncpg ì‚¬ìš©
        async_creator=getconn,
        poolclass=NullPool,
    )

# Line 44-51: Local Development
else:
    return create_async_engine(
        settings.DATABASE_URL,  # e.g. "postgresql+asyncpg://user:pass@localhost/db"
        ...
    )
```

**ê²°ë¡ :**

- Production: Cloud SQL Connectorë¥¼ í†µí•´ GCP Cloud SQLì— ì—°ê²°
- Development: `DATABASE_URL` í™˜ê²½ë³€ìˆ˜ë¡œ ì—°ê²°
- ë‘ ê²½ìš° ëª¨ë‘ `asyncpg` (PostgreSQL async ë“œë¼ì´ë²„) ì‚¬ìš©

### 2.2 Untitled Root Cause

**ì›ì¸:** DB ì—°ê²° ë¬¸ì œê°€ ì•„ë‹ˆë¼, `rclone lsjson`ì—ì„œ ë°˜í™˜ëœ [Name](file:///c:/Users/imtae/madcamp/2025Winter_4th/frontend/src/Code.gs#134-142) í•„ë“œê°€ DB ì €ì¥ ì‹œ í™œìš©ë˜ì§€ ì•Šì•˜ìŒ.

**ìˆ˜ì • ì „ (step_01_ingest.py):**

```python
# _fetch_drive_metadata: IDë§Œ ë°˜í™˜
drive_map[norm_path] = drive_id  # âŒ ì´ë¦„ ì—†ìŒ

# register_files_to_db: ë¡œì»¬ íŒŒì¼ëª… ì‚¬ìš©
drive_name=file_info["name"]  # âŒ ë¡œì»¬ íŒŒì¼ ì‹œìŠ¤í…œ ì´ë¦„
```

**ìˆ˜ì • í›„ (step_01_ingest.py):**

```python
# _fetch_drive_metadata: IDì™€ Name ëª¨ë‘ ë°˜í™˜
drive_map[norm_path] = {"id": drive_id, "name": name}  # âœ… ì´ë¦„ í¬í•¨

# register_files_to_db: Drive API ì´ë¦„ ì‚¬ìš©
file_name = drive_meta.get("name") or file_info.get("name", "Untitled")  # âœ…
drive_name=file_name  # âœ… Drive APIì—ì„œ ê°€ì ¸ì˜¨ ì‹¤ì œ ì´ë¦„
```

---

## 3. v2.0 vs v2.1 ì‹¬ì¸µ ë¹„êµ

### 3.1 ë™ì¼í•œ ì  (Core Architecture)

| êµ¬ì„±ìš”ì†Œ              | v2.0                                                                                                                  | v2.1                                                                                                                  | ë™ì¼ ì—¬ë¶€    |
| --------------------- | --------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------- | ------------ |
| ë°ì´í„° ì†ŒìŠ¤           | `doc.preprocessed_content` (DB)                                                                                       | `doc.preprocessed_content` (DB)                                                                                       | âœ… ë™ì¼      |
| DB ì¡°íšŒ ë°©ì‹          | `SELECT ... WHERE id = ?`                                                                                             | `SELECT ... WHERE drive_id = ?`                                                                                       | ğŸ”„ í‚¤ë§Œ ë‹¤ë¦„ |
| RAG íŒŒì´í”„ë¼ì¸ ì˜ì¡´ì„± | COMPLETED ìƒíƒœ í•„ìš”                                                                                                   | COMPLETED ìƒíƒœ í•„ìš”                                                                                                   | âœ… ë™ì¼      |
| Gemini ìš”ì•½ ë¡œì§      | [summarize_agenda_section()](file:///c:/Users/imtae/madcamp/2025Winter_4th/backend/app/services/ai/gemini.py#216-280) | [summarize_agenda_section()](file:///c:/Users/imtae/madcamp/2025Winter_4th/backend/app/services/ai/gemini.py#216-280) | âœ… ë™ì¼      |
| Placeholder ì¹˜í™˜      | `replace_placeholder()`                                                                                               | `replace_placeholder()`                                                                                               | âœ… ë™ì¼      |
| Google Docs ì¶œë ¥      | [GoogleDocsService](file:///c:/Users/imtae/madcamp/2025Winter_4th/backend/app/services/google/docs.py#29-361) ì‚¬ìš©    | [GoogleDocsService](file:///c:/Users/imtae/madcamp/2025Winter_4th/backend/app/services/google/docs.py#29-361) ì‚¬ìš©    | âœ… ë™ì¼      |

### 3.2 ì°¨ì´ì  (Frontend-Backend Contract)

| í•­ëª©              | v2.0                              | v2.1                                | ë³€ê²½ ì´ìœ                        |
| ----------------- | --------------------------------- | ----------------------------------- | ------------------------------- |
| **Frontend ì…ë ¥** | `source_document_id: int` (DB ID) | `transcript_doc_id: str` (Drive ID) | UX ê°œì„  (Picker ë³µì›)           |
| **Frontend UI**   | RAG Selectbox (Untitled í‘œì‹œ)     | Google Drive Picker                 | ì‚¬ìš©ì„± í–¥ìƒ                     |
| **DB ì¡°íšŒ í‚¤**    | `Document.id` (Primary Key)       | `Document.drive_id` (Unique)        | Frontendê°€ Drive IDë§Œ ì•Œê³  ìˆìŒ |
| **ì—ëŸ¬ ë©”ì‹œì§€**   | ê¸°ìˆ ì  (DB ID ê¸°ë°˜)               | ì‚¬ìš©ì ì¹œí™”ì  (Admin íƒ­ ì•ˆë‚´)       | UX ê°œì„                          |

### 3.3 ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨ ë¹„êµ

````carousel
### v2.0 Architecture

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant B as Backend
    participant DB as PostgreSQL

    F->>B: GET /rag/documents
    B->>DB: SELECT * FROM documents WHERE status='COMPLETED'
    DB-->>B: [Document list with IDs]
    B-->>F: [{id: 1, name: "Untitled"}, ...]
    U->>F: Selectboxì—ì„œ ì„ íƒ
    F->>B: POST /minutes/generate
    Note right of F: source_document_id: 1 (DB ID)
    B->>DB: SELECT * FROM documents WHERE id = 1
    DB-->>B: Document row
    B->>B: Summarize with Gemini
```
<!-- slide -->
### v2.1 Architecture

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant P as Google Picker
    participant B as Backend
    participant DB as PostgreSQL

    U->>F: Picker ë²„íŠ¼ í´ë¦­
    F->>P: Open Google Drive Picker
    P-->>F: Selected file (drive_id: "1ABC...")
    F->>B: POST /minutes/generate
    Note right of F: transcript_doc_id: "1ABC..." (Drive ID)
    B->>DB: SELECT * FROM documents WHERE drive_id = '1ABC...'
    alt ë¬¸ì„œ ìˆìŒ & COMPLETED
        DB-->>B: Document row
        B->>B: Summarize with Gemini
    else ë¬¸ì„œ ì—†ìŒ
        DB-->>B: None
        B-->>F: Error: "Admin íƒ­ì—ì„œ í•™ìŠµ í•„ìš”"
    end
```
````

---

## 4. ìµœì¢… ê²€ì¦ ê²°ë¡ 

### âœ… Pass Criteria ì¶©ì¡± í™•ì¸

| Criteria                                                | Status | Evidence                                                                                                           |
| ------------------------------------------------------- | ------ | ------------------------------------------------------------------------------------------------------------------ |
| `select(Document).where(Document.drive_id == ...)` ì¡´ì¬ | âœ…     | [features.py:125](file:///c:/Users/imtae/madcamp/2025Winter_4th/backend/app/tasks/features.py#L125)                |
| `docs_service.get_document_text()` ì—†ìŒ                 | âœ…     | grep ê²°ê³¼: 0 matches                                                                                               |
| `doc.preprocessed_content` ì‚¬ìš©                         | âœ…     | [features.py:152](file:///c:/Users/imtae/madcamp/2025Winter_4th/backend/app/tasks/features.py#L152)                |
| `asyncpg` (PostgreSQL) ì‚¬ìš©                             | âœ…     | [database.py:30](file:///c:/Users/imtae/madcamp/2025Winter_4th/backend/app/core/database.py#L30)                   |
| Untitled Fix ì ìš©                                       | âœ…     | [step_01_ingest.py:286](file:///c:/Users/imtae/madcamp/2025Winter_4th/backend/app/pipeline/step_01_ingest.py#L286) |

### ğŸ”’ ë³´ì¥ ì‚¬í•­

> **v2.1ì€ Legacyë¡œ ëŒì•„ê°€ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.**
>
> - ì†ê¸°ë¡ í…ìŠ¤íŠ¸ëŠ” **ë°˜ë“œì‹œ DBì˜ `preprocessed_content`ì—ì„œ** ê°€ì ¸ì˜µë‹ˆë‹¤.
> - Google Docs APIëŠ” **ê²°ê³¼ë¬¼ ìƒì„±(copy, insert)ì—ë§Œ** ì‚¬ìš©ë©ë‹ˆë‹¤.
> - Frontendê°€ ë³´ë‚¸ `transcript_doc_id`ëŠ” **DB ì¡°íšŒ í‚¤ë¡œë§Œ** ì‚¬ìš©ë©ë‹ˆë‹¤.
