# RAG íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼ (2026-02-01)

## ğŸ“Š í…ŒìŠ¤íŠ¸ ìš”ì•½

| í•­ëª© | ê²°ê³¼ |
|------|------|
| **í…ŒìŠ¤íŠ¸ ì¼ì‹œ** | 2026-01-31 15:25 (UTC) |
| **Google Drive í´ë”** | `1cXccLqJenflSHQunB6Zm4BU3eO9X-FLU` |
| **ë™ê¸°í™”ëœ íŒŒì¼** | 50ê°œ (26.3MB) |
| **DB ë“±ë¡ ë¬¸ì„œ** | 47ê°œ |
| **ìƒì„±ëœ ì²­í¬** | 162ê°œ |
| **ì„ë² ë”© ì™„ë£Œ** | âœ… ì„±ê³µ |

---

## âœ… í•´ê²°ëœ ë¬¸ì œë“¤

### 1. API â†’ Celery ì—°ê²° ë¬¸ì œ
- **ì¦ìƒ**: API í˜¸ì¶œ í›„ Celery taskê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
- **ì›ì¸**: `task_routes` ì„¤ì •ìœ¼ë¡œ ì¸í•œ queue ë¼ìš°íŒ… ë¶ˆì¼ì¹˜
- **í•´ê²°**: `celery_app.py`ì—ì„œ `task_routes` ì œê±°

### 2. Event Loop ì¶©ëŒ (RuntimeError)
- **ì¦ìƒ**: `Task got Future attached to a different loop`
- **ì›ì¸**: FastAPIì˜ async session factoryë¥¼ Celeryì—ì„œ ì¬ì‚¬ìš©
- **í•´ê²°**: `get_celery_session()` í•¨ìˆ˜ ì¶”ê°€í•˜ì—¬ Celery taskë§ˆë‹¤ ìƒˆ DB ì—°ê²° ìƒì„±

### 3. rclone ì„¤ì • ë¬¸ì œ
- **ì¦ìƒ**: `Config file not found`, `directory not found`
- **ì›ì¸**: Docker ì»¨í…Œì´ë„ˆì— rclone ì„¤ì • ì—†ìŒ
- **í•´ê²°**: 
  - `credentials/rclone.conf` íŒŒì¼ ìƒì„±
  - `docker-compose.yml`ì— ë§ˆìš´íŠ¸ ì¶”ê°€
  - `--drive-root-folder-id` ì˜µì…˜ ì‚¬ìš©

### 4. í•œê¸€ íŒŒì¼ëª… ì¸ì½”ë”© ì˜¤ë¥˜
- **ì¦ìƒ**: `UnicodeDecodeError: 'utf-8' codec can't decode`
- **ì›ì¸**: subprocessì—ì„œ `text=True` ì‚¬ìš© ì‹œ í•œê¸€ íŒŒì¼ëª… ë””ì½”ë”© ì‹¤íŒ¨
- **í•´ê²°**: ë°”ì´ë„ˆë¦¬ ëª¨ë“œë¡œ ì‹¤í–‰ í›„ `errors="replace"` ì˜µì…˜ìœ¼ë¡œ ìˆ˜ë™ ë””ì½”ë”©

### 5. rclone ì˜µì…˜ ì¶©ëŒ
- **ì¦ìƒ**: `-v`ì™€ `--log-level` ë™ì‹œ ì‚¬ìš© ì˜¤ë¥˜
- **í•´ê²°**: `-v` ì˜µì…˜ ì œê±°

---

## ğŸ—‚ï¸ ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

| íŒŒì¼ | ë³€ê²½ ë‚´ìš© |
|------|----------|
| `backend/app/tasks/celery_app.py` | `task_routes` ì œê±° |
| `backend/app/tasks/pipeline.py` | `get_celery_session()` ì¶”ê°€, `async_session_factory` êµì²´ |
| `backend/app/pipeline/step_01_ingest.py` | rclone ëª…ë ¹ì–´ ìˆ˜ì •, ì¸ì½”ë”© ì˜¤ë¥˜ í•´ê²° |
| `backend/app/schemas/rag_dto.py` | `skip_sync` ì˜µì…˜ ì¶”ê°€ |
| `credentials/rclone.conf` | ì‹ ê·œ ìƒì„± (Service Account ì„¤ì •) |
| `docker-compose.yml` | rclone.conf ë§ˆìš´íŠ¸ ê²½ë¡œ ìˆ˜ì • |

---

## ğŸ–¥ï¸ VMì—ì„œ í™•ì¸ ëª…ë ¹ì–´

### 1. ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
```bash
# Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ
docker ps

# Celery ì›Œì»¤ ë¡œê·¸ (ìµœê·¼ 50ì¤„)
docker logs council-ai-celery --tail 50

# Backend API ë¡œê·¸
docker logs council-ai-backend --tail 50
```

### 2. ë°ì´í„°ë² ì´ìŠ¤ í™•ì¸
```bash
# DB ì ‘ì† (PostgreSQL)
PGPASSWORD=madcamp1234 psql -h 34.64.80.96 -U postgres -d council-ai-sql

# ë˜ëŠ” Dockerì—ì„œ ì‹¤í–‰
docker run --rm -e PGPASSWORD=madcamp1234 postgres:16 psql -h 34.64.80.96 -U postgres -d council-ai-sql
```

#### DB ì¿¼ë¦¬ ëª¨ìŒ
```sql
-- ë¬¸ì„œ ìƒíƒœë³„ ê°œìˆ˜
SELECT status, COUNT(*) FROM documents GROUP BY status;

-- ìµœê·¼ ë“±ë¡ëœ ë¬¸ì„œ 10ê°œ
SELECT id, drive_name, status, doc_category 
FROM documents 
ORDER BY id DESC LIMIT 10;

-- ì´ ì²­í¬ ê°œìˆ˜
SELECT COUNT(*) as total_chunks FROM document_chunks;

-- ì™„ë£Œëœ ë¬¸ì„œì˜ ì²­í¬ ìˆ˜
SELECT d.id, d.drive_name, COUNT(c.id) as chunk_count
FROM documents d
LEFT JOIN document_chunks c ON d.id = c.document_id
WHERE d.status = 'COMPLETED'
GROUP BY d.id, d.drive_name;

-- ì„ë² ë”© í™•ì¸ (ë²¡í„° ì¡´ì¬ ì—¬ë¶€)
SELECT COUNT(*) as chunks_with_embedding 
FROM document_chunks 
WHERE embedding IS NOT NULL;
```

### 3. API í…ŒìŠ¤íŠ¸
```bash
# ë¬¸ì„œ ìˆ˜ì§‘ ì‹œì‘ (folder_idëŠ” ë³¸ì¸ í´ë”ë¡œ ë³€ê²½)
curl -X POST "http://localhost:8000/api/v1/rag/ingest/folder" \
  -H "Content-Type: application/json" \
  -d '{"folder_id": "1cXccLqJenflSHQunB6Zm4BU3eO9X-FLU"}'

# Celery task ìƒíƒœ í™•ì¸
curl "http://localhost:8000/api/v1/rag/task/{task_id}"

# ë¬¸ì„œ ëª©ë¡ ì¡°íšŒ
curl "http://localhost:8000/api/v1/rag/documents?limit=10"

# RAG ê²€ìƒ‰ í…ŒìŠ¤íŠ¸
curl -X POST "http://localhost:8000/api/v1/rag/search" \
  -H "Content-Type: application/json" \
  -d '{"query": "í•™ìƒíšŒ ì˜ˆì‚°", "top_k": 5}'
```

### 4. ë™ê¸°í™”ëœ íŒŒì¼ í™•ì¸
```bash
# ì»¨í…Œì´ë„ˆ ë‚´ë¶€ íŒŒì¼ ëª©ë¡
docker exec council-ai-celery ls -la /app/data/raw/

# íŠ¹ì • í´ë” ë‚´ìš©
docker exec council-ai-celery find /app/data/raw -type f | head -20

# rclone ì„¤ì • í™•ì¸
docker exec council-ai-celery cat /home/appuser/.config/rclone/rclone.conf

# rcloneìœ¼ë¡œ Google Drive ì§ì ‘ í™•ì¸
docker exec council-ai-celery rclone ls gdrive: --drive-root-folder-id 1cXccLqJenflSHQunB6Zm4BU3eO9X-FLU | head -20
```

### 5. ì„œë¹„ìŠ¤ ì¬ì‹œì‘
```bash
# ëª¨ë“  ì„œë¹„ìŠ¤ ì¬ì‹œì‘
docker-compose down && docker-compose up -d

# Celery ì›Œì»¤ë§Œ ì¬ë¹Œë“œ
docker-compose up -d --build celery_worker

# Backendë§Œ ì¬ë¹Œë“œ
docker-compose up -d --build backend
```

---

## âš ï¸ ì•Œë ¤ì§„ ì´ìŠˆ

### 1. Upstage API Rate Limit (429 Too Many Requests)
- ë™ì‹œì— ë§ì€ ë¬¸ì„œë¥¼ ì²˜ë¦¬í•˜ë©´ API í˜¸ì¶œ ì œí•œì— ê±¸ë¦¼
- í•´ê²° ë°©ì•ˆ: ë™ì‹œ ì²˜ë¦¬ ìˆ˜ ì œí•œ ë˜ëŠ” ì¬ì‹œë„ ë¡œì§ ì¶”ê°€ í•„ìš”

### 2. ì¼ë¶€ íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨ (400 Bad Request)
- ë¹ˆ íŒŒì¼(`.gitkeep`) ë˜ëŠ” ì§€ì›í•˜ì§€ ì•ŠëŠ” í˜•ì‹
- í•´ê²° ë°©ì•ˆ: íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬ ì¶”ê°€ í•„ìš”

### 3. PENDING ìƒíƒœ ë¬¸ì„œ
- 39ê°œ ë¬¸ì„œê°€ ì•„ì§ ì²˜ë¦¬ ëŒ€ê¸° ì¤‘
- Celery ì›Œì»¤ê°€ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬ ì¤‘ì´ë¯€ë¡œ ì‹œê°„ì´ ì§€ë‚˜ë©´ ì™„ë£Œë¨

---

## ğŸ“ˆ í˜„ì¬ ìƒíƒœ (2026-02-01 00:30 ê¸°ì¤€)

```
ë¬¸ì„œ ìƒíƒœ:
- COMPLETED: 6ê°œ  âœ…
- PENDING: 39ê°œ   â³
- FAILED: 2ê°œ     âŒ

ì²­í¬ ìƒì„±: 162ê°œ
ì„ë² ë”© ì™„ë£Œ: âœ…
```
