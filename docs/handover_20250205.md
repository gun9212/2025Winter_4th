# Council-AI 인수인계서 (2025-02-05)

## 1. 프로젝트 개요

**Council-AI**는 서울대학교 컴퓨터공학부 학생회의 문서 관리 및 RAG(Retrieval-Augmented Generation) 시스템입니다.

### 핵심 구성요소
- **Backend**: FastAPI + PostgreSQL(pgvector) + Celery + Redis
- **Frontend**: Google Apps Script (Google Docs Sidebar)
- **Infrastructure**: GCP Compute Engine, Docker Compose

### 주요 파이프라인 (7단계)
1. `step_01_ingest.py` - Google Drive에서 문서 수집
2. `step_02_classify.py` - 문서 분류 및 메타데이터 추출
3. `step_03_parse.py` - Upstage API로 문서 파싱
4. `step_04_preprocess.py` - 전처리
5. `step_05_chunk.py` - 청킹
6. `step_06_enrich.py` - 메타데이터 보강 및 이벤트 연결
7. `step_07_embed.py` - 임베딩 생성 및 벡터 DB 저장

---

## 2. 금일 완료된 작업

### 2.1 Google Drive ID 마이그레이션
**문제**: `drive_id`가 `local:FOLDER_ID/path/to/file` 형식으로 저장되어 Google Drive 원본 링크 생성 불가

**해결**:
- `backend/scripts/migrate_drive_ids.py` 스크립트 작성
- `rclone lsjson`으로 실제 Google Drive File ID 조회
- 59개 문서 중 50개 업데이트, 8개 중복 스킵, 1개 매칭 실패(.gitkeep)

**실행 명령어**:
```bash
docker compose cp backend/scripts/migrate_drive_ids.py backend:/tmp/migrate_drive_ids.py
docker compose exec -e PYTHONPATH=/app backend python /tmp/migrate_drive_ids.py --dry-run  # 시뮬레이션
docker compose exec -e PYTHONPATH=/app backend python /tmp/migrate_drive_ids.py  # 실제 실행
```

**롤백 방법**:
```bash
docker compose exec -e PYTHONPATH=/app backend python /app/scripts/rollback_drive_ids.py \
  --backup-file /tmp/council-ai/backup/drive_id_backup_YYYYMMDD_HHMMSS.json
```

### 2.2 Year 필드 2025 고정
**문제**: 문서의 `year` 필드가 다양한 값으로 저장됨

**해결**:
1. **기존 레코드**: `backend/scripts/fix_year_2025.py` 스크립트로 일괄 업데이트
2. **신규 레코드**: `backend/app/pipeline/step_06_enrich.py` 수정
   ```python
   # Line 96-97
   # Step 5: Set year (FIXED to 2025 per business requirement)
   document.year = 2025
   ```

**커밋**: `5ebc0a1 fix: year 부분 2025 로 fix`

### 2.3 Event 테이블 정리
**문제점 및 해결**:

| 문제 | 해결 |
|------|------|
| year=2026인 이벤트 6개 | `UPDATE events SET year = 2025 WHERE year = 2026;` |
| 중복 이벤트 (백학자유로리조트) | Event 82 → 80으로 병합 후 삭제 |
| "null" 타이틀 이벤트 (71, 79) | **미해결** - 아래 참조 |

---

## 3. 현재 시스템 상태

### 3.1 Database 상태 (2025-02-05 기준)

**Documents 테이블**:
- 총 59개 문서
- 모든 문서 year=2025
- 50개 문서에 실제 Google Drive ID 적용
- 9개 문서 event_id=NULL (orphan)

**Events 테이블**:
```
 id |       title        | year | doc_count
----+--------------------+------+-----------
 71 | null               | 2025 |        24  ← 수정 필요
 72 | 집행위원회 국장단  | 2025 |        11
 73 | 인수인계           | 2025 |         2
 74 | FLOW               | 2025 |         2
 75 | 국장단 1차 LT      | 2025 |         3
 76 | 국장단회의         | 2025 |         1
 77 | 컴공 로비공간 제안 | 2025 |         1
 78 | MT                 | 2025 |         1
 79 | null               | 2025 |         2  ← 수정 필요
 80 | 백학자유로리조트   | 2025 |         2
 81 | 오크밸리 행사      | 2025 |         1
```

### 3.2 서버 접속 정보
- **서버**: GCP Compute Engine
- **경로**: `/home/imtae/2025Winter_4th`
- **DB 접속**:
  ```bash
  PGPASSWORD=madcamp1234 psql -h 34.47.64.114 -U postgres -d council-ai-sql
  ```

---

## 4. 미해결 과제 (TODO)

### 4.1 [긴급] "null" 타이틀 이벤트 수정

Event 71과 79의 title이 문자열 "null"로 저장되어 있음.

**확인 명령어**:
```bash
PGPASSWORD=madcamp1234 psql -h 34.47.64.114 -U postgres -d council-ai-sql -c "
SELECT e.id as event_id, d.id as doc_id, LEFT(d.drive_name, 60) as doc_name
FROM events e
JOIN documents d ON e.id = d.event_id
WHERE e.title = 'null'
ORDER BY e.id, d.id;"
```

**수정 방법** (문서 내용 확인 후):
```bash
PGPASSWORD=madcamp1234 psql -h 34.47.64.114 -U postgres -d council-ai-sql -c "
UPDATE events SET title = '적절한_타이틀' WHERE id = 71;"
```

### 4.2 Orphan 문서 이벤트 연결

9개 문서가 event_id=NULL 상태:
- `[별첨3] 2025 컴퓨터공학부 학생회 FLOW 정기 사업용 기획안 양식.docx`
- `[별첨 1] 교수님과 밥약 어때 사업 기획안.docx`
- `[별첨 4] 2025-1 개강파티 사업 보고서.pdf`
- `.gitkeep`
- 등

**원인**: `_infer_event_from_document()` 함수의 패턴 매칭 실패

**해결 옵션**:
1. 수동으로 적절한 event_id 할당
2. `step_06_enrich.py`의 패턴 추가

### 4.3 이벤트 추론 로직 개선

현재 `backend/app/pipeline/step_06_enrich.py:308-347`의 `_infer_event_from_document()` 함수가 제한된 패턴만 인식:
- `제N차 OOO 회의`
- `OOO 관련`
- `국장단/운영위원회/집행위원회/학생총회`

**개선 제안**:
- `[별첨]`, `기획안`, `보고서` 등의 패턴 추가
- 폴더 경로 기반 이벤트 추론 강화

---

## 5. 주요 스크립트 위치

| 스크립트 | 용도 |
|----------|------|
| `backend/scripts/migrate_drive_ids.py` | Drive ID 마이그레이션 |
| `backend/scripts/rollback_drive_ids.py` | Drive ID 롤백 |
| `backend/scripts/fix_year_2025.py` | Year 필드 일괄 수정 |
| `backend/app/pipeline/step_06_enrich.py` | 메타데이터 보강 (year 고정 로직 포함) |

---

## 6. 자주 사용하는 명령어

### Docker 관련
```bash
cd /home/imtae/2025Winter_4th
docker compose restart backend celery_worker  # 코드 변경 후 재시작
docker compose logs -f backend  # 로그 확인
docker compose exec backend bash  # 컨테이너 접속
```

### DB 조회
```bash
# Docker 내부에서
docker compose exec db psql -U council -d council_ai -c "SELECT * FROM documents LIMIT 5;"

# 외부에서 직접 접속
PGPASSWORD=madcamp1234 psql -h 34.47.64.114 -U postgres -d council-ai-sql
```

### 파이프라인 실행
```bash
docker compose exec -e PYTHONPATH=/app backend python -m app.tasks.pipeline
```

---

## 7. 참고 문서

- `docs/drive_id_migration.md` - Drive ID 마이그레이션 가이드
- `CLAUDE.md` - 프로젝트 전체 개발 규칙 및 구조

---

**작성일**: 2025-02-05
**작성자**: Claude (AI Assistant)
**다음 담당자 액션**: "null" 타이틀 이벤트 수정 및 orphan 문서 처리
